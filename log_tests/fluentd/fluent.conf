<source>
  @type  tail
  path /log/*.log
  read_from_head true
  pos_file /tmp/fluentd.log.pos
#  format none
  format multiline
  keep_time_key true
  format_firstline /^\d{4}-\d{2}-\d{2}/
  format1 /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?<thread>\[.*\])[\s]+(?<level>[A-Z]+)[\s]+(?<message>.*)/
  tag input.file.r24
</source>

#rewrite tag to rabbitmq token
<match input.file.*>
  @type rewrite_tag_filter
  <rule>  
    key $['level']
    pattern ^(.+)$
    tag log.${tag_parts[2]}.$1
  </rule>
</match>

#<filter input.file.*>
#  @type record_transformer
#  <record>
#    tag log.${tag_parts[2]}.${record["level"]}
#  </record>
#</filter>


<match **>
  @type amqp
  
  tag_key true
  # Set broker host and port
  host localhost
  port 5672

  # Set user and password for authentication
  user guest
  pass guest

  # Configure amqp entities vhost, exchange id and type
  vhost /
  exchange test_exchange
  exchange_type topic
  durable true # optionally set exchange durability - default is true.
  payload_only false # optional - default is false. if true, only the payload will be sent. if false, data format is { "key" => tag, "timestamp" => time, "payload" => record }.
  content_type application/json # optional - default is application/octet-stream. some amqp consumers will expect application/json.
  priority 0 # the priority for the message - requires bunny >= 1.1.6 and rabbitmq >= 3.5
</match>
